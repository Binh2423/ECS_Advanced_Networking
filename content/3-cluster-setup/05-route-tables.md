---
title : "Route Tables"
date : "`r Sys.Date()`"
weight : 5
chapter : false
pre : " <b> 3.5 </b> "
---

# T·∫°o Route Tables

## M·ª•c ti√™u

Route Tables ƒë·ªãnh tuy·∫øn traffic trong VPC. Ch√∫ng ta s·∫Ω t·∫°o:
- **1 Public Route Table** - Route traffic t·ª´ public subnets ra internet qua IGW
- **2 Private Route Tables** - Route traffic t·ª´ private subnets ra internet qua NAT Gateways

## Ki·∫øn tr√∫c Routing

{{< mermaid >}}
graph TB
    subgraph "VPC: 10.0.0.0/16"
        subgraph "Public Route Table"
            PRT[Public RT<br/>0.0.0.0/0 ‚Üí IGW]
        end
        
        subgraph "Private Route Tables"
            PRT1[Private RT 1<br/>0.0.0.0/0 ‚Üí NAT GW 1]
            PRT2[Private RT 2<br/>0.0.0.0/0 ‚Üí NAT GW 2]
        end
        
        PUB1[Public Subnet 1] --> PRT
        PUB2[Public Subnet 2] --> PRT
        PRIV1[Private Subnet 1] --> PRT1
        PRIV2[Private Subnet 2] --> PRT2
    end
    
    PRT --> IGW[Internet Gateway]
    PRT1 --> NAT1[NAT Gateway 1]
    PRT2 --> NAT2[NAT Gateway 2]
{{< /mermaid >}}

## Ph∆∞∆°ng ph√°p 1: S·ª≠ d·ª•ng AWS Console

### B∆∞·ªõc 1: Truy c·∫≠p Route Tables Console

{{< console-interaction >}}
**üìç V·ªã tr√≠:** VPC Console ‚Üí Route Tables

**H√†nh ƒë·ªông:**
1. Trong VPC Console, click v√†o **Route Tables** ·ªü menu b√™n tr√°i
2. Click **Create route table**

**üì∏ Screenshot c·∫ßn ch·ª•p:**
- [ ] Route Tables dashboard
- [ ] Create route table button
{{< /console-interaction >}}

### B∆∞·ªõc 2: T·∫°o Public Route Table

{{< console-interaction >}}
**üìç V·ªã tr√≠:** Create route table form

**C·∫•u h√¨nh:**
- **Name:** `Public-Route-Table`
- **VPC:** Ch·ªçn `ECS-Workshop-VPC`

**H√†nh ƒë·ªông sau khi t·∫°o:**
1. Select route table v·ª´a t·∫°o
2. Tab **Routes** ‚Üí **Edit routes**
3. **Add route:** `0.0.0.0/0` ‚Üí Target: Internet Gateway ‚Üí Ch·ªçn IGW
4. Tab **Subnet associations** ‚Üí **Edit subnet associations**
5. Ch·ªçn c·∫£ 2 public subnets

**üì∏ Screenshot c·∫ßn ch·ª•p:**
- [ ] Create route table form
- [ ] Routes configuration v·ªõi IGW
- [ ] Subnet associations v·ªõi public subnets
{{< /console-interaction >}}

## Ph∆∞∆°ng ph√°p 2: S·ª≠ d·ª•ng AWS CLI

### T·∫°o Public Route Table

{{< code-block language="bash" title="T·∫°o Public Route Table" description="Route table cho public subnets v·ªõi route t·ªõi Internet Gateway" >}}
# Load environment variables
source workshop-env.sh

echo "üõ£Ô∏è Creating Public Route Table..."

# T·∫°o Public Route Table
PUBLIC_RT=$(aws ec2 create-route-table \
    --vpc-id $VPC_ID \
    --tag-specifications 'ResourceType=route-table,Tags=[
        {Key=Name,Value=Public-Route-Table},
        {Key=Type,Value=Public},
        {Key=Project,Value=ECS-Workshop}
    ]' \
    --query 'RouteTable.RouteTableId' \
    --output text)

echo "‚úÖ Public Route Table created: $PUBLIC_RT"

# Th√™m route t·ªõi Internet Gateway
aws ec2 create-route \
    --route-table-id $PUBLIC_RT \
    --destination-cidr-block 0.0.0.0/0 \
    --gateway-id $IGW_ID

echo "‚úÖ Route to Internet Gateway added"

# Associate v·ªõi public subnets
aws ec2 associate-route-table --subnet-id $PUBLIC_SUBNET_1 --route-table-id $PUBLIC_RT
aws ec2 associate-route-table --subnet-id $PUBLIC_SUBNET_2 --route-table-id $PUBLIC_RT

echo "‚úÖ Public subnets associated with Public Route Table"
{{< /code-block >}}

### T·∫°o Private Route Tables

{{< code-block language="bash" title="T·∫°o Private Route Tables" description="Route tables cho private subnets v·ªõi routes t·ªõi NAT Gateways" >}}
echo "üõ£Ô∏è Creating Private Route Tables..."

# Private Route Table 1 (cho Private Subnet 1)
PRIVATE_RT_1=$(aws ec2 create-route-table \
    --vpc-id $VPC_ID \
    --tag-specifications 'ResourceType=route-table,Tags=[
        {Key=Name,Value=Private-Route-Table-1},
        {Key=Type,Value=Private},
        {Key=AZ,Value=1},
        {Key=Project,Value=ECS-Workshop}
    ]' \
    --query 'RouteTable.RouteTableId' \
    --output text)

# Route t·ªõi NAT Gateway 1
aws ec2 create-route \
    --route-table-id $PRIVATE_RT_1 \
    --destination-cidr-block 0.0.0.0/0 \
    --nat-gateway-id $NAT_GW_1

# Associate v·ªõi Private Subnet 1
aws ec2 associate-route-table --subnet-id $PRIVATE_SUBNET_1 --route-table-id $PRIVATE_RT_1

echo "‚úÖ Private Route Table 1 created and configured: $PRIVATE_RT_1"

# Private Route Table 2 (cho Private Subnet 2)
PRIVATE_RT_2=$(aws ec2 create-route-table \
    --vpc-id $VPC_ID \
    --tag-specifications 'ResourceType=route-table,Tags=[
        {Key=Name,Value=Private-Route-Table-2},
        {Key=Type,Value=Private},
        {Key=AZ,Value=2},
        {Key=Project,Value=ECS-Workshop}
    ]' \
    --query 'RouteTable.RouteTableId' \
    --output text)

# Route t·ªõi NAT Gateway 2
aws ec2 create-route \
    --route-table-id $PRIVATE_RT_2 \
    --destination-cidr-block 0.0.0.0/0 \
    --nat-gateway-id $NAT_GW_2

# Associate v·ªõi Private Subnet 2
aws ec2 associate-route-table --subnet-id $PRIVATE_SUBNET_2 --route-table-id $PRIVATE_RT_2

echo "‚úÖ Private Route Table 2 created and configured: $PRIVATE_RT_2"
{{< /code-block >}}

### L∆∞u Route Table IDs

{{< code-block language="bash" title="L∆∞u Route Table IDs" >}}
# L∆∞u Route Table IDs v√†o environment file
cat >> workshop-env.sh << EOF
export PUBLIC_RT=$PUBLIC_RT
export PRIVATE_RT_1=$PRIVATE_RT_1
export PRIVATE_RT_2=$PRIVATE_RT_2
EOF

echo "üíæ Route Table IDs saved to workshop-env.sh"
{{< /code-block >}}

## X√°c minh k·∫øt qu·∫£

### Ki·ªÉm tra Route Tables

{{< code-block language="bash" title="Ki·ªÉm tra Route Tables" >}}
echo "üìã Route Table Summary:"
echo "======================"

# Function ƒë·ªÉ hi·ªÉn th·ªã route table info
show_route_table() {
    local rt_id=$1
    local rt_name=$(aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Tags[?Key==`Name`].Value|[0]' --output text)
    local routes=$(aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Routes[?DestinationCidrBlock==`0.0.0.0/0`].[DestinationCidrBlock,GatewayId,NatGatewayId]' --output text)
    
    echo "$rt_name ($rt_id):"
    if [[ $routes == *"igw-"* ]]; then
        echo "  ‚úì Route: 0.0.0.0/0 ‚Üí Internet Gateway"
    elif [[ $routes == *"nat-"* ]]; then
        echo "  ‚úì Route: 0.0.0.0/0 ‚Üí NAT Gateway"
    fi
    echo ""
}

show_route_table $PUBLIC_RT
show_route_table $PRIVATE_RT_1
show_route_table $PRIVATE_RT_2
{{< /code-block >}}

### Ki·ªÉm tra Subnet Associations

{{< code-block language="bash" title="Ki·ªÉm tra Subnet Associations" >}}
echo "üîó Subnet Associations:"
echo "======================="

# Ki·ªÉm tra associations cho t·ª´ng route table
check_associations() {
    local rt_id=$1
    local rt_name=$(aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Tags[?Key==`Name`].Value|[0]' --output text)
    
    echo "$rt_name:"
    aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Associations[?SubnetId!=null].[SubnetId]' --output text | while read subnet_id; do
        if [ -n "$subnet_id" ]; then
            subnet_name=$(aws ec2 describe-subnets --subnet-ids $subnet_id --query 'Subnets[0].Tags[?Key==`Name`].Value|[0]' --output text)
            echo "  ‚úì $subnet_name ($subnet_id)"
        fi
    done
    echo ""
}

check_associations $PUBLIC_RT
check_associations $PRIVATE_RT_1
check_associations $PRIVATE_RT_2
{{< /code-block >}}

## Test Routing

### T·∫°o script test routing

{{< code-block language="bash" title="Test Routing Script" file="test-routing.sh" >}}
cat > test-routing.sh << 'EOF'
#!/bin/bash
source workshop-env.sh

echo "üß™ Testing Route Table Configuration..."
echo "======================================"

# Function to test route table
test_route_table() {
    local rt_id=$1
    local rt_name=$2
    local expected_target=$3
    
    echo "Testing $rt_name ($rt_id):"
    
    # Get route information
    route_info=$(aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Routes[?DestinationCidrBlock==`0.0.0.0/0`]' --output json)
    
    if [ "$route_info" = "[]" ]; then
        echo "  ‚ùå No default route found"
        return 1
    fi
    
    # Check target
    if echo "$route_info" | grep -q "$expected_target"; then
        echo "  ‚úÖ Default route correctly points to $expected_target"
    else
        echo "  ‚ùå Default route does not point to expected target"
        echo "  Route info: $route_info"
        return 1
    fi
    
    # Check associations
    associations=$(aws ec2 describe-route-tables --route-table-ids $rt_id --query 'RouteTables[0].Associations[?SubnetId!=null].SubnetId' --output text)
    if [ -n "$associations" ]; then
        echo "  ‚úÖ Subnets associated: $(echo $associations | wc -w) subnet(s)"
    else
        echo "  ‚ùå No subnets associated"
        return 1
    fi
    
    echo ""
    return 0
}

# Test all route tables
echo "1. Testing Public Route Table..."
test_route_table $PUBLIC_RT "Public-Route-Table" "igw-"

echo "2. Testing Private Route Table 1..."
test_route_table $PRIVATE_RT_1 "Private-Route-Table-1" "nat-"

echo "3. Testing Private Route Table 2..."
test_route_table $PRIVATE_RT_2 "Private-Route-Table-2" "nat-"

echo "‚úÖ Route table testing completed!"
EOF

chmod +x test-routing.sh
./test-routing.sh
{{< /code-block >}}

## Troubleshooting

### L·ªói th∆∞·ªùng g·∫∑p

{{< alert type="warning" title="Route Already Exists" >}}
**L·ªói:** `RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists`

**Gi·∫£i ph√°p:**
- Route ƒë√£ t·ªìn t·∫°i, c√≥ th·ªÉ b·ªè qua l·ªói n√†y
- Ki·ªÉm tra routes hi·ªán t·∫°i: `aws ec2 describe-route-tables --route-table-ids $RT_ID`
- X√≥a route c≈© n·∫øu c·∫ßn: `aws ec2 delete-route --route-table-id $RT_ID --destination-cidr-block 0.0.0.0/0`
{{< /alert >}}

{{< alert type="warning" title="Association Already Exists" >}}
**L·ªói:** `Resource.AlreadyAssociated: resource subnet-xxx is already associated with route table rtb-xxx`

**Gi·∫£i ph√°p:**
- Subnet ƒë√£ ƒë∆∞·ª£c associate v·ªõi route table kh√°c
- Ki·ªÉm tra current association: `aws ec2 describe-route-tables --filters "Name=association.subnet-id,Values=$SUBNET_ID"`
- Disassociate tr∆∞·ªõc khi associate m·ªõi
{{< /alert >}}

### Debug Commands

{{< code-block language="bash" title="Debug Commands" >}}
# Xem t·∫•t c·∫£ route tables trong VPC
aws ec2 describe-route-tables --filters "Name=vpc-id,Values=$VPC_ID" --query 'RouteTables[*].[RouteTableId,Tags[?Key==`Name`].Value|[0]]' --output table

# Xem routes c·ªßa m·ªôt route table
aws ec2 describe-route-tables --route-table-ids $PUBLIC_RT --query 'RouteTables[0].Routes' --output table

# Xem subnet associations
aws ec2 describe-route-tables --route-table-ids $PUBLIC_RT --query 'RouteTables[0].Associations' --output table

# Ki·ªÉm tra NAT Gateway status
aws ec2 describe-nat-gateways --nat-gateway-ids $NAT_GW_1 $NAT_GW_2 --query 'NatGateways[*].[NatGatewayId,State]' --output table
{{< /code-block >}}

## Hi·ªÉu v·ªÅ Route Tables

{{< alert type="info" title="üí° Route Tables Best Practices" >}}
**T·∫°i sao t√°ch ri√™ng Private Route Tables?**

üîÑ **Fault Isolation:** N·∫øu 1 NAT Gateway fail, ch·ªâ 1 AZ b·ªã ·∫£nh h∆∞·ªüng  
üí∞ **Cost Optimization:** Tr√°nh cross-AZ data transfer charges  
‚ö° **Performance:** Traffic ƒëi qua NAT Gateway g·∫ßn nh·∫•t  
üîí **Security:** C√≥ th·ªÉ apply different routing policies per AZ  
{{< /alert >}}

## T√≥m t·∫Øt

üéâ **Ho√†n th√†nh!** B·∫°n ƒë√£ t·∫°o th√†nh c√¥ng:

‚úÖ 1 Public Route Table v·ªõi route t·ªõi Internet Gateway  
‚úÖ 2 Private Route Tables v·ªõi routes t·ªõi NAT Gateways  
‚úÖ Subnet associations ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng  
‚úÖ Environment variables ƒë√£ ƒë∆∞·ª£c l∆∞u  

## B∆∞·ªõc ti·∫øp theo

Route Tables ƒë√£ s·∫µn s√†ng! Ti·∫øp theo ch√∫ng ta s·∫Ω t·∫°o Security Groups.

{{< button href="../06-security-groups/" >}}Ti·∫øp theo: Security Groups ‚Üí{{< /button >}}

---

{{< alert type="tip" title="üí° Tip" >}}
**Monitoring:** S·ª≠ d·ª•ng VPC Flow Logs ƒë·ªÉ monitor traffic routing v√† troubleshoot connectivity issues.
{{< /alert >}}
